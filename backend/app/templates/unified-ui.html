<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¤–å–åº—é“ºå››ä»¶å¥— - ä¸€é¡µå››è¡¨å•</title>
  <style>
    :root {
      --paper: #f6f1e7;
      --ink: #2d2a24;
      --muted: #6d655a;
      --card-bg: #fffdf8;
      --border: #e6dccb;
      --shadow: 0 18px 40px rgba(32, 24, 16, 0.12);
      --radius: 18px;
      --space: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Noto Sans SC", "Source Han Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
      color: var(--ink);
      background: var(--paper);
      background-image:
        radial-gradient(circle at 10% 10%, rgba(255, 255, 255, 0.7) 0, rgba(255, 255, 255, 0) 45%),
        radial-gradient(circle at 90% 20%, rgba(255, 255, 255, 0.6) 0, rgba(255, 255, 255, 0) 50%),
        linear-gradient(120deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0));
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 36px 20px 80px;
    }

    header {
      padding: 32px 32px 30px;
      border-radius: 22px;
      background: linear-gradient(120deg, #ede2d0 0%, #f7efe2 55%, #efe4d4 100%);
      border: 1px solid #e6d8c5;
      box-shadow: 0 12px 26px rgba(32, 24, 16, 0.12);
      position: relative;
      overflow: hidden;
    }

    header::after {
      content: "";
      position: absolute;
      top: -60px;
      right: -40px;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, rgba(155, 91, 42, 0.18), rgba(155, 91, 42, 0));
    }

    .brand-mark {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(155, 91, 42, 0.12);
      color: #8a4b1f;
      font-weight: 600;
      font-size: 0.95rem;
      letter-spacing: 1px;
    }

    .brand-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9b5b2a;
      display: inline-block;
    }

    .title {
      font-family: "Noto Serif SC", "Songti SC", "STSong", serif;
      font-size: 2.2rem;
      margin: 12px 0 8px;
      letter-spacing: 1px;
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
    }

    .module-card {
      margin-top: 28px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 26px 26px 30px;
      position: relative;
      overflow: hidden;
    }

    .module-card::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 8px;
      background: var(--accent, #9b5b2a);
    }

    .module-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding-bottom: 16px;
      border-bottom: 1px dashed #e4d6c4;
    }

    .module-title {
      font-family: "Noto Serif SC", "Songti SC", "STSong", serif;
      font-size: 1.55rem;
      margin: 0;
    }

    .module-tag {
      padding: 6px 14px;
      border-radius: 999px;
      color: white;
      font-size: 0.85rem;
      background: var(--accent, #9b5b2a);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .module-desc {
      margin: 12px 0 20px;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px 22px;
    }

    .field-grid.full {
      grid-template-columns: 1fr;
    }

    label {
      display: block;
      font-size: 0.92rem;
      margin-bottom: 6px;
      color: #4a433a;
    }

    input[type="text"],
    input[type="number"],
    input[type="file"],
    textarea,
    select {
      width: 100%;
      border: 1px solid #d8cbb8;
      border-radius: 12px;
      padding: 10px 12px;
      background: #fffaf2;
      font-size: 0.95rem;
      color: var(--ink);
      outline: none;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent, #9b5b2a);
      box-shadow: 0 0 0 3px rgba(155, 91, 42, 0.15);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      font-size: 0.9rem;
      color: #4a433a;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff6ea;
      border: 1px solid #ead7c4;
      border-radius: 999px;
      padding: 6px 12px;
      margin: 0;
      cursor: pointer;
    }

    .upload-section {
      margin-top: 16px;
    }

    .upload-input {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .upload-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 18px 20px;
      border-radius: 16px;
      border: 1.5px dashed #d7c8b3;
      background: linear-gradient(135deg, rgba(255, 248, 236, 0.95), rgba(255, 252, 246, 0.9));
      box-shadow: 0 10px 24px rgba(32, 24, 16, 0.08);
      cursor: pointer;
      transition: border 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }

    .upload-card:hover {
      border-color: #b07a4a;
      box-shadow: 0 14px 30px rgba(32, 24, 16, 0.14);
      transform: translateY(-1px);
    }

    .upload-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: rgba(155, 91, 42, 0.15);
      display: grid;
      place-items: center;
      color: #8a4b1f;
      font-size: 1.3rem;
    }

    .upload-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #3d352b;
    }

    .upload-desc {
      font-size: 0.88rem;
      color: var(--muted);
    }

    .upload-filename {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #8a4b1f;
    }

    .range-wrap {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    input[type="range"] {
      accent-color: var(--accent, #9b5b2a);
    }

    .hint {
      font-size: 0.82rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-top: 18px;
      flex-wrap: wrap;
    }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 12px 22px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #fff;
      background: var(--accent, #9b5b2a);
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(0, 0, 0, 0.16);
    }

    .status {
      font-size: 0.9rem;
      color: #2f5f3f;
    }

    .error {
      margin-top: 10px;
      color: #b42318;
      font-size: 0.9rem;
    }

    .is-error {
      border-color: #b42318 !important;
      box-shadow: 0 0 0 3px rgba(180, 35, 24, 0.12) !important;
    }

    .split {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }

    @media (max-width: 960px) {
      .field-grid,
      .split {
        grid-template-columns: 1fr;
      }

      .checkbox-group {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .module-head {
        flex-direction: column;
        align-items: flex-start;
      }

      .checkbox-group {
        grid-template-columns: 1fr;
      }

      .btn-primary {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand-mark"><span class="brand-dot"></span>å‘ˆå°šç­–åˆ’</div>
      <h1 class="title">å¤–å–åº—é“ºå››ä»¶å¥—ä¸€é¡µç”Ÿæˆå°</h1>
      <p class="subtitle">ä¸€é¡µå¡«å†™å››ä»½æ–¹æ¡ˆï¼Œç‚¹å‡»æŒ‰é’®ç›´æ¥ä¸‹è½½ PDFï¼Œçœå»é¢„è§ˆæ­¥éª¤ã€‚</p>
    </header>

    <form class="module-card" data-module="brand" data-report-name="å“ç‰Œå®šä½åˆ†æ" style="--accent:#9B5B2A;">
      <div class="module-head">
        <h2 class="module-title">å“ç‰Œå®šä½åˆ†æ</h2>
        <span class="module-tag">å“ç‰Œä¸»çº¿</span>
      </div>
      <p class="module-desc">ç”¨äºå®šä½ç»“è®ºã€å·®å¼‚åŒ–å–ç‚¹ä¸èœå•ç»“æ„å»ºè®®ã€‚</p>

      <div class="field-grid">
        <div>
          <label for="brand-storeName">åº—é“ºåç§° *</label>
          <input id="brand-storeName" name="storeName" type="text" placeholder="å¦‚ï¼šå´å®¶ç‰›ç¾Šè‚‰é¦†" required />
        </div>
        <div>
          <label for="brand-category">ç»è¥å“ç±» *</label>
          <input id="brand-category" name="category" type="text" placeholder="å¦‚ï¼šç‰›ç¾Šè‚‰ã€çƒ§çƒ¤ã€å¿«é¤" required />
        </div>
        <div class="field-grid full">
          <label for="brand-address">åº—é“ºåœ°å€</label>
          <input id="brand-address" name="address" type="text" placeholder="å¦‚ï¼šXXå¸‚XXåŒºXXè·¯" />
        </div>
      </div>

      <div class="field-grid" style="margin-top:16px;">
        <div>
          <label>ç›®æ ‡å®¢ç¾¤</label>
          <div class="checkbox-group" data-group="targetGroup">
            <label><input type="checkbox" name="targetGroup" value="ç™½é¢†ä¸Šç­æ—" />ç™½é¢†ä¸Šç­æ—</label>
            <label><input type="checkbox" name="targetGroup" value="å­¦ç”Ÿç¾¤ä½“" />å­¦ç”Ÿç¾¤ä½“</label>
            <label><input type="checkbox" name="targetGroup" value="å¥èº«çˆ±å¥½è€…" />å¥èº«çˆ±å¥½è€…</label>
            <label><input type="checkbox" name="targetGroup" value="å¹´è½»æ¶ˆè´¹è€…" />å¹´è½»æ¶ˆè´¹è€…</label>
            <label><input type="checkbox" name="targetGroup" value="å®¶åº­ç”¨æˆ·" />å®¶åº­ç”¨æˆ·</label>
            <label><input type="checkbox" name="targetGroup" value="å¤œå®µç”¨æˆ·" />å¤œå®µç”¨æˆ·</label>
          </div>
        </div>
        <div>
          <label for="brand-priceRange">ä»·æ ¼åŒºé—´ï¼ˆäººå‡ï¼‰</label>
          <div class="range-wrap">
            <input id="brand-priceRange" name="priceRange" type="range" min="10" max="120" step="5" value="35" />
            <div class="hint">å½“å‰ï¼š<span data-role="priceValue">35</span> å…ƒ</div>
          </div>
        </div>
      </div>

      <div class="field-grid full" style="margin-top:16px;">
        <label for="brand-mainProducts">ä¸»è¥äº§å“</label>
        <input id="brand-mainProducts" name="mainProducts" type="text" placeholder="å¦‚ï¼šæ‰‹åˆ‡ç‰›è‚‰é¢ã€éº»è¾£é¦™é”…ã€æ‹›ç‰Œçƒ¤ä¸²" />
      </div>

      <div class="actions">
        <button class="btn-primary" type="button" data-action="download">ä¸‹è½½PDF</button>
        <span class="status" data-role="status"></span>
      </div>
      <div class="error" data-role="error"></div>
    </form>

    <form class="module-card" data-module="market" data-report-name="å•†åœˆè°ƒç ”åˆ†æ" style="--accent:#2F6FBD;">
      <div class="module-head">
        <h2 class="module-title">å•†åœˆè°ƒç ”åˆ†æ</h2>
        <span class="module-tag">å•†åœˆæ´å¯Ÿ</span>
      </div>
      <p class="module-desc">å…³æ³¨å®¢ç¾¤ã€æ¶ˆè´¹åŠ›ä¸ç«äº‰å¼ºåº¦ï¼Œæ”¯æŒæˆªå›¾è¾…åŠ©åˆ†æã€‚</p>

      <div class="field-grid">
        <div>
          <label for="market-storeName">åº—é“ºåç§° *</label>
          <input id="market-storeName" name="storeName" type="text" placeholder="å¦‚ï¼šå´å®¶ç‰›ç¾Šè‚‰é¦†" required />
        </div>
        <div>
          <label for="market-location">æ‰€åœ¨ä½ç½® *</label>
          <input id="market-location" name="location" type="text" placeholder="å¦‚ï¼šXXåœ°é“å£/å†™å­—æ¥¼ç¾¤" required />
        </div>
        <div>
          <label for="market-areaType">å•†åœˆç±»å‹ *</label>
          <select id="market-areaType" name="areaType" required>
            <option value="å†™å­—æ¥¼å•†åœˆ">å†™å­—æ¥¼å•†åœˆ</option>
            <option value="ç¤¾åŒºå•†åœˆ">ç¤¾åŒºå•†åœˆ</option>
            <option value="é«˜æ ¡å•†åœˆ">é«˜æ ¡å•†åœˆ</option>
            <option value="ç»¼åˆå•†ä¸šåŒº">ç»¼åˆå•†ä¸šåŒº</option>
            <option value="äº¤é€šæ¢çº½">äº¤é€šæ¢çº½</option>
          </select>
        </div>
      </div>

      <div class="upload-section">
        <input id="market-screenshot" class="upload-input" name="screenshot" type="file" accept="image/*" required />
        <label class="upload-card" for="market-screenshot">
          <div class="upload-icon">ğŸ“·</div>
          <div>
            <div class="upload-title">ä¸Šä¼ ç«å“æˆªå›¾ï¼ˆå¿…é€‰ï¼‰</div>
            <div class="upload-desc">å»ºè®®åŒ…å«åº—é“ºåˆ—è¡¨ä¿¡æ¯ï¼Œæ”¯æŒ JPG/PNGã€‚</div>
            <div class="upload-filename" data-role="marketScreenshotName">æœªé€‰æ‹©æ–‡ä»¶</div>
          </div>
        </label>
        <div class="hint">ç”¨äºæå–ç«å“åº—é“ºä¿¡æ¯ä¸å¯¹æ¯”åˆ†æã€‚</div>
      </div>

      <div class="actions">
        <button class="btn-primary" type="button" data-action="download">ä¸‹è½½PDF</button>
        <span class="status" data-role="status"></span>
      </div>
      <div class="error" data-role="error"></div>
    </form>

    <form class="module-card" data-module="store-activity" data-report-name="åº—é“ºæ´»åŠ¨æ–¹æ¡ˆ" style="--accent:#E07A2F;">
      <div class="module-head">
        <h2 class="module-title">åº—é“ºæ´»åŠ¨æ–¹æ¡ˆ</h2>
        <span class="module-tag">æ´»åŠ¨ç­–åˆ’</span>
      </div>
      <p class="module-desc">å›´ç»•æ»¡å‡ã€è¿”åˆ¸ä¸å¥—é¤æ­é…ç»™å‡ºå¯è½åœ°æ–¹æ¡ˆã€‚</p>

      <div class="field-grid">
        <div>
          <label for="activity-storeName">åº—é“ºåç§° *</label>
          <input id="activity-storeName" name="storeName" type="text" placeholder="å¦‚ï¼šå´å®¶ç‰›ç¾Šè‚‰é¦†" required />
        </div>
        <div>
          <label for="activity-storeAddress">åº—é“ºåœ°å€</label>
          <input id="activity-storeAddress" name="storeAddress" type="text" placeholder="å¦‚ï¼šXXå¸‚XXåŒºXXè·¯" />
        </div>
        <div>
          <label for="activity-businessCategory">ç»è¥å“ç±» *</label>
          <input id="activity-businessCategory" name="businessCategory" type="text" placeholder="å¦‚ï¼šç‰›ç¾Šè‚‰ã€çƒ§çƒ¤" required />
        </div>
        <div>
          <label for="activity-businessHours">è¥ä¸šæ—¶é—´</label>
          <input id="activity-businessHours" name="businessHours" type="text" placeholder="å¦‚ï¼š10:00-22:00" />
        </div>
      </div>

      <div class="field-grid full" style="margin-top:16px;">
        <label for="activity-menuItems">èœå“åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªèœå“ï¼‰</label>
        <textarea id="activity-menuItems" name="menuItems" placeholder="å¦‚ï¼š
æ‹›ç‰Œç‰›è‚‰é¢ 26
ç¾Šè‚‰ä¸² 8
ç§˜åˆ¶å¤å‘³æ‹¼ç›˜ 28"></textarea>
      </div>

      <div class="actions">
        <button class="btn-primary" type="button" data-action="download">ä¸‹è½½PDF</button>
        <span class="status" data-role="status"></span>
      </div>
      <div class="error" data-role="error"></div>
    </form>

    <form class="module-card" data-module="data-statistics" data-report-name="æ•°æ®ç»Ÿè®¡åˆ†æ" style="--accent:#6B5FB5;">
      <div class="module-head">
        <h2 class="module-title">æ•°æ®ç»Ÿè®¡åˆ†æ</h2>
        <span class="module-tag">è¿è¥è¯Šæ–­</span>
      </div>
      <p class="module-desc">å¡«å†™ 30 å¤©æ ¸å¿ƒæ•°æ®ï¼Œè‡ªåŠ¨ç»™å‡ºæ¼æ–—ä¸é…é€ä¼˜åŒ–å»ºè®®ã€‚</p>

      <div class="field-grid">
        <div>
          <label for="stats-storeName">åº—é“ºåç§° *</label>
          <input id="stats-storeName" name="storeName" type="text" placeholder="å¦‚ï¼šå´å®¶ç‰›ç¾Šè‚‰é¦†" required />
        </div>
        <div>
          <label for="stats-storeAddress">åº—é“ºåœ°å€ *</label>
          <input id="stats-storeAddress" name="storeAddress" type="text" placeholder="å¦‚ï¼šXXå¸‚XXåŒºXXè·¯" required />
        </div>
        <div>
          <label for="stats-businessCategory">ç»è¥å“ç±» *</label>
          <input id="stats-businessCategory" name="businessCategory" type="text" placeholder="å¦‚ï¼šç‰›ç¾Šè‚‰ã€å¿«é¤" required />
        </div>
        <div>
          <label for="stats-businessHours">è¥ä¸šæ—¶é—´ *</label>
          <input id="stats-businessHours" name="businessHours" type="text" placeholder="å¦‚ï¼š10:00-22:00" required />
        </div>
      </div>

      <div class="field-grid" style="margin-top:16px;">
        <div>
          <label for="stats-exposureCount">æ›å…‰äººæ•° *</label>
          <input id="stats-exposureCount" name="exposureCount" type="number" min="0" placeholder="å¦‚ï¼š38000" required />
        </div>
        <div>
          <label for="stats-visitCount">å…¥åº—äººæ•° *</label>
          <input id="stats-visitCount" name="visitCount" type="number" min="0" placeholder="å¦‚ï¼š4200" required />
        </div>
        <div>
          <label for="stats-orderCount">ä¸‹å•äººæ•° *</label>
          <input id="stats-orderCount" name="orderCount" type="number" min="0" placeholder="å¦‚ï¼š1260" required />
        </div>
        <div>
          <label for="stats-visitConversion">å…¥åº—è½¬åŒ–ç‡ï¼ˆ%ï¼‰</label>
          <input id="stats-visitConversion" name="visitConversion" type="number" min="0" step="0.01" placeholder="å¦‚ï¼š11.05" />
        </div>
        <div>
          <label for="stats-orderConversion">ä¸‹å•è½¬åŒ–ç‡ï¼ˆ%ï¼‰</label>
          <input id="stats-orderConversion" name="orderConversion" type="number" min="0" step="0.01" placeholder="å¦‚ï¼š29.6" />
        </div>
      </div>

      <div class="field-grid" style="margin-top:16px;">
        <div>
          <label for="stats-minOrderPrice">èµ·é€ä»· *</label>
          <input id="stats-minOrderPrice" name="minOrderPrice" type="number" min="0" placeholder="å¦‚ï¼š25" required />
        </div>
        <div>
          <label for="stats-deliveryFee">é…é€è´¹ *</label>
          <input id="stats-deliveryFee" name="deliveryFee" type="number" min="0" placeholder="å¦‚ï¼š3" required />
        </div>
        <div>
          <label for="stats-deliveryRange">é…é€èŒƒå›´ï¼ˆå…¬é‡Œï¼‰*</label>
          <input id="stats-deliveryRange" name="deliveryRange" type="number" min="0" step="0.1" placeholder="å¦‚ï¼š3" required />
        </div>
      </div>

      <div class="field-grid" style="margin-top:16px;">
        <div>
          <label for="stats-idleCookingTime">é—²æ—¶å‡ºé¤æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
          <input id="stats-idleCookingTime" name="idleCookingTime" type="number" min="0" value="15" readonly />
          <div class="hint">é»˜è®¤ 15 åˆ†é’Ÿï¼Œæ— éœ€å¡«å†™ã€‚</div>
        </div>
        <div>
          <label for="stats-busyCookingTime">å¿™æ—¶å‡ºé¤æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
          <input id="stats-busyCookingTime" name="busyCookingTime" type="number" min="0" value="20" readonly />
          <div class="hint">é»˜è®¤ 20 åˆ†é’Ÿï¼Œæ— éœ€å¡«å†™ã€‚</div>
        </div>
      </div>

      <div class="field-grid" style="margin-top:16px;">
        <div>
          <label for="stats-greenCharity">é’å±±å…¬ç›Š</label>
          <select id="stats-greenCharity" name="greenCharity">
            <option value="æ˜¯" selected>æ˜¯</option>
            <option value="å¦">å¦</option>
          </select>
        </div>
        <div>
          <label for="stats-selfPickup">åˆ°åº—è‡ªå–</label>
          <select id="stats-selfPickup" name="selfPickup">
            <option value="æ˜¯" selected>æ˜¯</option>
            <option value="å¦">å¦</option>
          </select>
        </div>
        <div>
          <label for="stats-preOrder">æ¥å—é¢„è®¢å•</label>
          <select id="stats-preOrder" name="preOrder">
            <option value="æ˜¯" selected>æ˜¯</option>
            <option value="å¦">å¦</option>
          </select>
        </div>
        <div>
          <label for="stats-onTimeGuarantee">å‡†æ—¶å®</label>
          <select id="stats-onTimeGuarantee" name="onTimeGuarantee">
            <option value="æ˜¯" selected>æ˜¯</option>
            <option value="å¦">å¦</option>
          </select>
        </div>
        <div>
          <label for="stats-foodSafety">æ”¾å¿ƒåƒ</label>
          <select id="stats-foodSafety" name="foodSafety">
            <option value="æ˜¯" selected>æ˜¯</option>
            <option value="å¦">å¦</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn-primary" type="button" data-action="download">ä¸‹è½½PDF</button>
        <span class="status" data-role="status"></span>
      </div>
      <div class="error" data-role="error"></div>
    </form>
  </div>

  <script>
    (() => {
      const moduleNameMap = {
        "brand": "å“ç‰Œå®šä½åˆ†æ",
        "market": "å•†åœˆè°ƒç ”åˆ†æ",
        "store-activity": "åº—é“ºæ´»åŠ¨æ–¹æ¡ˆ",
        "data-statistics": "æ•°æ®ç»Ÿè®¡åˆ†æ"
      };

      const illegalFilenameChars = /[\\\\/:*?\"<>|]/g;

      const isTauriEnvironment = () =>
        typeof window !== "undefined" &&
        window.__TAURI__ &&
        window.__TAURI__.core &&
        typeof window.__TAURI__.core.invoke === "function";

      const saveBinaryInTauri = async (bytes, filename, filters) => {
        const filePath = await window.__TAURI__.core.invoke("plugin:dialog|save", {
          options: {
            defaultPath: filename,
            title: "ä¿å­˜æ–‡ä»¶",
            filters
          }
        });
        if (!filePath) {
          return { canceled: true };
        }
        await window.__TAURI__.core.invoke(
          "plugin:fs|write_file",
          bytes,
          {
            headers: {
              path: encodeURIComponent(filePath),
              options: JSON.stringify({})
            }
          }
        );
        return { canceled: false, path: filePath };
      };

      const safeText = (el, text) => {
        if (el) el.textContent = text || "";
      };

      const sanitizeFilename = (name) => (name || "").replace(illegalFilenameChars, "_").trim();

      function parseErrorMessage(rawText) {
        if (!rawText) return "";
        try {
          const data = JSON.parse(rawText);
          return data.detail || data.error || rawText;
        } catch {
          return rawText;
        }
      }

      const parseDispositionFilename = (header) => {
        if (!header) return "";
        const starMatch = header.match(/filename\\*=UTF-8''([^;]+)/i);
        if (starMatch && starMatch[1]) {
          try {
            return decodeURIComponent(starMatch[1]);
          } catch {
            return starMatch[1];
          }
        }
        const normalMatch = header.match(/filename=\"?([^\";]+)\"?/i);
        return normalMatch ? normalMatch[1] : "";
      };

      const triggerDownload = (blob, filename) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      };

      const collectPayload = (form, module) => {
        const payload = {};
        const elements = Array.from(form.querySelectorAll("[name]"));

        elements.forEach((el) => {
          const name = el.name;
          if (!name || el.type === "file") return;
          if (name === "targetGroup") return;

          if (el.type === "checkbox") {
            payload[name] = el.checked;
            return;
          }

          if (el.type === "number") {
            payload[name] = el.value === "" ? "" : Number(el.value);
            return;
          }

          if (el.type === "range") {
            payload[name] = el.value ? `${el.value}å…ƒ` : "";
            return;
          }

          payload[name] = (el.value || "").trim();
        });

        if (module === "brand") {
          const targetGroups = Array.from(form.querySelectorAll('input[name="targetGroup"]:checked'))
            .map((el) => (el.value || "").trim())
            .filter(Boolean);
          payload.targetGroup = targetGroups.join("ã€");
        }

        if (module === "data-statistics") {
          const exposure = Number(payload.exposureCount || 0);
          const visit = Number(payload.visitCount || 0);
          const order = Number(payload.orderCount || 0);

          if (!payload.visitConversion && exposure > 0 && visit > 0) {
            payload.visitConversion = Number(((visit / exposure) * 100).toFixed(2));
          }
          if (!payload.orderConversion && visit > 0 && order > 0) {
            payload.orderConversion = Number(((order / visit) * 100).toFixed(2));
          }
        }

        return payload;
      };

      const validatePayload = (form, module, payload, screenshotFile) => {
        const requiredMap = {
          storeName: "åº—é“ºåç§°",
          category: "ç»è¥å“ç±»",
          location: "æ‰€åœ¨ä½ç½®",
          areaType: "å•†åœˆç±»å‹",
          storeAddress: "åº—é“ºåœ°å€",
          businessCategory: "ç»è¥å“ç±»",
          businessHours: "è¥ä¸šæ—¶é—´",
          exposureCount: "æ›å…‰äººæ•°",
          visitCount: "å…¥åº—äººæ•°",
          orderCount: "ä¸‹å•äººæ•°",
          minOrderPrice: "èµ·é€ä»·",
          deliveryFee: "é…é€è´¹",
          deliveryRange: "é…é€èŒƒå›´"
        };

        const markError = (name) => {
          const el = form.querySelector(`[name="${name}"]`);
          if (el) el.classList.add("is-error");
        };

        const valueOf = (name) => {
          const el = form.querySelector(`[name="${name}"]`);
          return el ? (el.value || "").trim() : "";
        };

        const missing = [];
        const check = (name) => {
          if (!valueOf(name)) {
            missing.push(requiredMap[name] || name);
            markError(name);
          }
        };

        if (module === "brand") {
          check("storeName");
          check("category");
        }

        if (module === "market") {
          check("storeName");
          check("location");
          check("areaType");
          if (!screenshotFile) {
            return "è¯·ä¸Šä¼ ç«å“æˆªå›¾ã€‚";
          }
        }

        if (module === "store-activity") {
          check("storeName");
          check("businessCategory");
        }

        if (module === "data-statistics") {
          ["storeName", "storeAddress", "businessCategory", "businessHours"].forEach(check);
          ["exposureCount", "visitCount", "orderCount", "minOrderPrice", "deliveryFee", "deliveryRange"].forEach(check);

          const exposure = Number(payload.exposureCount || 0);
          const visit = Number(payload.visitCount || 0);
          const order = Number(payload.orderCount || 0);
          if (visit > exposure) {
            return "å…¥åº—äººæ•°ä¸èƒ½è¶…è¿‡æ›å…‰äººæ•°ã€‚";
          }
          if (order > visit) {
            return "ä¸‹å•äººæ•°ä¸èƒ½è¶…è¿‡å…¥åº—äººæ•°ã€‚";
          }
        }

        if (missing.length) {
          return `è¯·å¡«å†™ï¼š${missing.join("ã€")}`;
        }

        return "";
      };

      const setupPriceRange = (form) => {
        const priceInput = form.querySelector('input[name="priceRange"]');
        const priceValue = form.querySelector('[data-role="priceValue"]');
        if (!priceInput || !priceValue) return;
        priceValue.textContent = priceInput.value;
        priceInput.addEventListener("input", () => {
          priceValue.textContent = priceInput.value;
        });
      };

      const resetFieldErrors = (form) => {
        form.querySelectorAll(".is-error").forEach((el) => el.classList.remove("is-error"));
      };

      document.querySelectorAll("form[data-module]").forEach((form) => {
        const module = form.dataset.module;
        const reportName = form.dataset.reportName || moduleNameMap[module] || module;
        const button = form.querySelector('[data-action="download"]');
        const statusEl = form.querySelector('[data-role="status"]');
        const errorEl = form.querySelector('[data-role="error"]');
        const screenshotInput = form.querySelector('input[type="file"][name="screenshot"]');

        setupPriceRange(form);

        form.querySelectorAll("input, textarea, select").forEach((el) => {
          el.addEventListener("input", () => el.classList.remove("is-error"));
          el.addEventListener("change", () => el.classList.remove("is-error"));
        });

        if (module === "market" && screenshotInput) {
          const nameEl = form.querySelector('[data-role="marketScreenshotName"]');
          const updateName = () => {
            const file = screenshotInput.files && screenshotInput.files[0];
            if (nameEl) {
              nameEl.textContent = file ? file.name : "æœªé€‰æ‹©æ–‡ä»¶";
            }
          };
          screenshotInput.addEventListener("change", updateName);
          updateName();
        }

        if (!button) return;
        const defaultText = button.textContent;

        button.addEventListener("click", async () => {
          resetFieldErrors(form);
          safeText(errorEl, "");
          safeText(statusEl, "ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™â€¦");
          button.disabled = true;
          button.textContent = "ç”Ÿæˆä¸­â€¦";

          const payload = collectPayload(form, module);
          const screenshotFile = screenshotInput ? screenshotInput.files[0] : null;

          const validationError = validatePayload(form, module, payload, screenshotFile);
          if (validationError) {
            safeText(statusEl, "");
            safeText(errorEl, validationError);
            button.disabled = false;
            button.textContent = defaultText;
            return;
          }

          const formData = new FormData();
          formData.append("module", module);
          formData.append("payload_json", JSON.stringify(payload));
          if (module === "market" && screenshotFile) {
            formData.append("screenshot", screenshotFile);
          }

          try {
            const response = await fetch("/api/generate", { method: "POST", body: formData });
            if (!response.ok) {
              const rawText = await response.text();
              const message = parseErrorMessage(rawText);
              throw new Error(message || "ç”Ÿæˆå¤±è´¥");
            }

            const headerFilename = parseDispositionFilename(response.headers.get("content-disposition"));
            const storeName = sanitizeFilename(payload.storeName || payload.areaName || "æœªå‘½ååº—é“º");
            const fallbackName = `${storeName}_${reportName}.pdf`;
            const downloadName = fallbackName || sanitizeFilename(headerFilename);

            if (isTauriEnvironment()) {
              const buffer = await response.arrayBuffer();
              const bytes = new Uint8Array(buffer);
              const result = await saveBinaryInTauri(bytes, downloadName, [
                { name: "PDFæ–‡ä»¶", extensions: ["pdf"] },
                { name: "æ‰€æœ‰æ–‡ä»¶", extensions: ["*"] }
              ]);
              if (result.canceled) {
                safeText(statusEl, "å·²å–æ¶ˆä¿å­˜");
                return;
              }
              safeText(statusEl, "PDFå·²ä¿å­˜");
            } else {
              const blob = await response.blob();
              triggerDownload(blob, downloadName);
              safeText(statusEl, "PDFå·²å¼€å§‹ä¸‹è½½");
            }
          } catch (err) {
            safeText(statusEl, "");
            safeText(errorEl, `ä¸‹è½½å¤±è´¥ï¼š${err && err.message ? err.message : err}`);
          } finally {
            button.disabled = false;
            button.textContent = defaultText;
          }
        });
      });
    })();
  </script>
</body>
</html>
